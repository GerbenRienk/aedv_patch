<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="stylesheet" href="style.css" type="text/css" />
</head>
<body>
<script src="jquery.min.js"></script>
<script>
$.noConflict();
jQuery(document).ready(function($) { 
	var xml_data;
	var select_options = "<option value='0'>Negative<option value='1'>&#x00B1;<option value='2'>+<option value='3'>++<option value='4'>+++</select>";
	$.ajax({
		type: "GET",
		url: "substances.xml",
		dataType: "xml",
		success: saveXML
	});
	function saveXML(xml){
		// store the xml-object
		xml_data = xml;
		composeMakers(xml_data);
	}
	
	function setEventHandlersSerie(){
		// remove the existing events
		$(':checkbox.serie').off("change");
		$(':checkbox.serie').change(function() {
			if($(this).is(":checked")) {
				composeSelects($(this)[0].id);
			}else{
				var div_id = "#div_" + $(this)[0].id;
				$(div_id).remove();
			}
		});
	}
	function composeMakers(xml){
		//console.log("in compose makers");
		$(xml).find("maker").each(function(){
			$("#makers").append($("<input class='maker' />") // a new input element ..
				.attr("type", "checkbox") // .. of type checkbox ..
				.attr("id", $(this).attr("maker_id")) // .. with given name
			)
			$("#makers").append($(this).attr("maker_name"));
			$("#makers").append(" <br />");
		});
	}

	function parseXML(xml){
		//console.log("in parse");
		$(xml).find("serie").each(function(){
			$("#series").append($("<input class='serie' />") // a new input element ..
				.attr("type", "checkbox") // .. of type checkbox ..
				.attr("id", $(this).attr("serie_id")) // .. with given name
			)
			$("#series").append($(this).attr("serie_name"));
			$("#series").append(" <br />");
		});
	}
	
	function composeSeries(maker_id){
		console.log("in composeSeries for " + maker_id );
		var serie_div;
		serie_div = "<div id='div_" + maker_id + "'>"
		//this is a bit sloppy, but loop again through the makers
		$(xml_data).find("maker").each(function(){
			if ($(this).attr("maker_id") == maker_id){
				serie_div = serie_div + "<b>" + $(this).attr("maker_name") + "</b><br />";
				$(this).find("serie").each(function(){
					serie_div = serie_div + "<input type='checkbox' class='serie' id='" + $(this).attr("serie_id") + "' />";
					serie_div = serie_div + $(this).attr("serie_name") + " <br />"
				})
			serie_div = serie_div + "";
			}
		})
		serie_div = serie_div + "</div>";
		$("#series").append(serie_div);
		setEventHandlersSerie();
		
	}

	function composeSelects(serie_id){
		var select_div;
		select_div = "<div id='div_" + serie_id + "'>"
		//this is a bit sloppy, but loop again through the series
		$(xml_data).find("serie").each(function(){
			if ($(this).attr("serie_id") == serie_id){
				select_div = select_div + "<b>" + $(this).attr("serie_name") + "</b><br /><table>";
				$(this).find("substance").each(function(){
					select_div = select_div + "<tr><td>" + $(this).text() + "</td><td><select id='sel_" + $(this).attr("substance_id") + "'>";
					select_div = select_div + select_options + "</td></tr>";
				})
			select_div = select_div + "</table>";
			}
		})
		select_div = select_div + "</div>";
		$("#substances").append(select_div);	
	}

	window.setTimeout(function(){
		// define what will happen when we click the maker checkboxes
		$(':checkbox.maker').change(function() {
			if($(this).is(":checked")) {
				composeSeries($(this)[0].id);
			}else{
				var div_id = "#div_" + $(this)[0].id;
				$(div_id).find("input:checkbox:checked").each(function(){
					$("#div_" + $(this)[0].id).remove();
				})
				$(div_id).remove();
			}
		});
	},100);
	
	// what to do when we click submit
	$("#back_to_oc").click(function(){
        var input_on_opener = window.opener.document.getElementById("the_input_id");
        // list the makers
        var selections = '{"makers":[';
        $("#makers").find("input:checkbox:checked").each(function(){
        	selections = selections + '"' + $(this)[0].id + '",';
				})
		// remove last comma
		selections = selections.substr(0,selections.length - 1);
        selections = selections + ']';
        $(input_on_opener).val(selections);
        close();
     });
	
})
</script>

<div id="wrapper">
	<div id="makers">Step 1: select the maker(s)<br /></div>
	<div id="series">Step 2: select the patch(es)/serie(s)<br /></div>
	<div id="substances">Step 3: select the outcome</div>
	<div id="action">Step 4: <input type="button" value="write to openclinica" id="back_to_oc" /></div>
</div>
</body>
</html>